#+STARTUP: content
#+SETUPFILE: ~/.emacs.d/org-styles/html/main.theme
#+TITLE: ecma-script
#+DATE: [2021-01-20 22:05]
* Refers è§„èŒƒ
- https://jelly.jd.com/article/5febdfbb846cc00148ae36d7
- https://backbencher.dev/javascript/es2021-new-features
- https://codeburst.io/exciting-features-of-javascript-es2021-es12-1de8adf6550b

* ECMAScript å’Œ JavaScript åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ 
è¦è®²æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å›é¡¾å†å².
   
1996 å¹´ 11 æœˆï¼ŒJavaScript çš„åˆ›é€ è€… Netscape å…¬å¸ï¼Œ
å†³å®šå°† JavaScript æäº¤ç»™æ ‡å‡†åŒ–ç»„ç»‡ ECMAï¼Œ
å¸Œæœ›è¿™ç§è¯­è¨€èƒ½å¤Ÿæˆä¸ºå›½é™…æ ‡å‡†.

æ¬¡å¹´ï¼ŒECMA å‘å¸ƒ 262 å·æ ‡å‡†æ–‡ä»¶ï¼ˆECMA-262ï¼‰çš„ç¬¬ä¸€ç‰ˆï¼Œ
è§„å®šäº†æµè§ˆå™¨è„šæœ¬è¯­è¨€çš„æ ‡å‡†ï¼Œå¹¶å°†è¿™ç§è¯­è¨€ç§°ä¸º ECMAScript, 
è¿™ä¸ªç‰ˆæœ¬å°±æ˜¯ 1.0 ç‰ˆ.
è¯¥æ ‡å‡†ä»ä¸€å¼€å§‹å°±æ˜¯é’ˆå¯¹ JavaScript è¯­è¨€åˆ¶å®šçš„, 
ä½†æ˜¯ä¹‹æ‰€ä»¥ä¸å« JavaScript, æœ‰ä¸¤ä¸ªåŸå› .

ä¸€æ˜¯å•†æ ‡, Java æ˜¯ Sun å…¬å¸çš„å•†æ ‡, æ ¹æ®æˆæƒåè®®, 
åªæœ‰ Netscape å…¬å¸å¯ä»¥åˆæ³•åœ°ä½¿ç”¨ JavaScript è¿™ä¸ªåå­—, 
ä¸” JavaScript æœ¬èº«ä¹Ÿå·²ç»è¢« Netscape å…¬å¸æ³¨å†Œä¸ºå•†æ ‡.

äºŒæ˜¯æƒ³ä½“ç°è¿™é—¨è¯­è¨€çš„åˆ¶å®šè€…æ˜¯ ECMA, ä¸æ˜¯ Netscape, 
è¿™æ ·æœ‰åˆ©äºä¿è¯è¿™é—¨è¯­è¨€çš„å¼€æ”¾æ€§å’Œä¸­ç«‹æ€§.
   
å› æ­¤, ECMAScript å’Œ JavaScript çš„å…³ç³»æ˜¯, 
å‰è€…æ˜¯åè€…çš„è§„æ ¼, åè€…æ˜¯å‰è€…çš„ä¸€ç§å®ç°ï¼ˆå¦å¤–çš„ ECMAScript æ–¹è¨€è¿˜æœ‰ Jscript å’Œ ActionScriptï¼‰.
æ—¥å¸¸åœºåˆ, è¿™ä¸¤ä¸ªè¯æ˜¯å¯ä»¥äº’æ¢çš„.

* nodejs
nodejs é»˜è®¤ä½¿ç”¨ CommonJS è§„èŒƒ

é€šè¿‡ ~.mjs~ åç¼€æˆ–è€…æŒ‡å®š ~package.json~  ~"type": "module"~  å±¬æ€§.
** ä¸ CJS çš„ä¸åŒ
1. strict mode
2. æµè§ˆå™¨å…¼å®¹
   å¯ä»¥é€šè¿‡è®¾ç½® ~type~ æ¥ä½¿ç”¨, å½“ä¸”ä»…å½“æœ‰ ~mjs~ åç¼€æ—¶å¯ç”¨.
   ä¸æ”¯æŒè·¯å¾„æ£€ç´¢.

   #+begin_src html
     <script type="module" src="esm-module.mjs"></script>;
   #+end_src

   å¯ä»¥é€šè¿‡ [[*https://github.com/WICG/import-maps][Import Maps]] æ¥æ§åˆ¶ä¾èµ–

   #+begin_src html
     <script type="module">
       import _ from 'lodash';
     </script>

     <script type="importmap">
       {
       "imports": {
       "lodash": "./node_modules/lodash-es/lodash.js"
       }
       }
     </script>
   #+end_src

3. é™æ€è§£æ
   CJS å¼•ç”¨æ¨¡å—çš„æ—¶å€™, ä¼šæŠŠæ¨¡å—å½“æˆæ–‡ä»¶è§£æä¹‹è¡Œ, ç›´åˆ°æŠ¥é”™.
   ESM ä¸ä¼šæ‰§è¡Œä»»ä½•æ¨¡å—, ç›´åˆ°åŠ è½½è§£æå®Œæ‰€æœ‰æ¨¡å—.
4. å¼‚æ­¥
   å¼•å…¥ä¸ä¼šæ‰“æ–­æ‰§è¡Œ,  ~import~ æ‰§è¡Œä¼šæ’å…¥äº‹ä»¶é˜Ÿåˆ—è€Œä¸æ˜¯åƒ CJS ä¸€æ ·ç›´æ¥æ‰“æ–­ç­‰å¾…å¼•ç”¨æ¨¡å—æ‰§è¡Œå®Œæˆ.

* 2023
** findLast().findLastIndex()
** hashbang
#+begin_src js
  // #!/usr/bin/env node
#+end_src

* 2022

** .at method on built-in indexables ğŸ“•.
#+begin_src js
  const cart = ['ğŸ', 'ğŸŒ', 'ğŸ'];

  // first element
  cart.at(0); // 'ğŸ'

  // last element
  cart.at(-1); // 'ğŸ'

  // out of bounds
  cart.at(-100); // undefined 
  cart.at(100); // undefined 
#+end_src

** RegExp Match Indices
additional information about the start and end indices of captured substrings ğŸ“•

#+begin_src js
  /(?<xs>x+)(?<ys>y+)/.exec('xxxyyxx');
  /*[
    'xxxyy',
    'xxx',
    'yy',
    index: 0,
    input: 'xxxyyxx',
    groups: [Object: null prototype] { xs: 'xxx', ys: 'yy' }
    ]*/
#+end_src

** Object.hasOwn
Object.hasOwn ğŸ“•

#+begin_src js
  let books = {}
  books.prop = 'exists';

  // `hasOwn` will only return true for direct properties:
  Object.hasOwn(books, 'prop');             // returns true
  Object.hasOwn(books, 'toString');         // returns false
  Object.hasOwn(books, 'hasOwnProperty');   // returns false

  // The `in` operator will return true for direct or inherited properties:
  'prop' in books;                          // returns true
  'toString' in books;                      // returns true
  'hasOwnProperty' in books;                // returns true
#+end_src

** Error cause
#+begin_src js
  async function doJob() {
    const rawResource = await fetch('//domain/resource-a')
          .catch(err => {
            throw new Error('Download raw resource failed', { cause: err });
          });
    const jobResult = doComputationalHeavyJob(rawResource);
    await fetch('//domain/upload', { method: 'POST', body: jobResult })
      .catch(err => {
        throw new Error('Upload job result failed', { cause: err });
      });
  }

  try {
    await doJob();
  } catch (e) {
    console.log(e);
    console.log('Caused by', e.cause);
  }
  // Error: Upload job result failed
  // Caused by TypeError: Failed to fetch
#+end_src

** Top-Level await
#+begin_src js
  console.log(await Promise.resolve('ğŸ'));
#+end_src

** Class field declarations
Orthogonally-informed combination of public and private fields. ğŸ“•
#+begin_src js
  class SampleClass {
      /*
        instead of:
        constructor() { this.publicID = 42; }
      ,*/
      publicID = 42; // public field

      /*
        instead of:
        static get staticPublicField() { return -1 }
      ,*/
      static staticPublicField = -1;

      // static private field
      static #staticPrivateField = 'private';

      //private methods
      #privateMethod() {}

      // static block
      static {
        // executed when the class is created
      }
  }
#+end_src
* 2021 Features
- String.prototype.replaceAll( )
- ç§æœ‰æ–¹æ³• Private Methods ä¸ç§æœ‰è®¿é—®è€… Private Accessors
- Promise.any ä¸ AggregateError
- WeakRefs å¼±å¼•ç”¨
- é€»è¾‘è¿ç®—ç¬¦å’Œèµ‹å€¼è¡¨è¾¾å¼

** String.prototype.replaceAll( )
~replace~ å¯ä»¥åšå•ä¸ªæ›¿æ¢, ä¹‹å‰éƒ½æ˜¯ ~split~ å† ~join~ çš„æ–¹å¼åšåˆ°, ä½†æ²¡åŠæ³•å¯¹æ­£åˆ™æ¯”è¾ƒå¥½çš„å¤„ç†.

#+begin_src js
  const str = "The brown fox is really brown";

  //Instead of doing this...
  const newStr = str.replace(/brown/g, "White");

  //You'll be able to do this...
  const newStr = str.replaceAll("brown", "White");
#+end_src
    
** ç§æœ‰æ–¹æ³• Private Methods

ç§æœ‰æ–¹æ³•åªèƒ½åœ¨å®šä¹‰å®ƒçš„ç±»å†…éƒ¨è®¿é—®, ä¸“ç”¨æ–¹æ³•åç§°ä»¥å¼€å¤´ ~#~

#+begin_src js
  class Person {

    // Private method
    #setType() {
      console.log("I am Private");
    }

    // Public method
    show() {
      this.#setType();
    }

  }

  const personObj = new Person()
  personObj.show() // "I am Private"
  personObj.setType() // TypeError: personObj.setType is not a function
#+end_src
    
** ç§æœ‰è®¿é—®è€… Private Accessors

å¯ä»¥é€šè¿‡ ~#~ åœ¨å‡½æ•°åç§°å‰æ·»åŠ è®¿é—®å™¨å‡½æ•°æ¥ä½¿å…¶ç§æœ‰

#+begin_src js
  class Person {
    // Public accessor
    get name() { return "Backbencher" }
    set name(value) {}

    // Private accessor
    get #age() { return 42 }
    set #age(value) {}
  }

  const obj = new Person()
  console.log(obj.name) // "Backbencher"
  console.log(obj.age) // undefined
#+end_src

** Promise.any å’Œ AggregateError

å½“åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ª ~promise~ æˆåŠŸ ~resolve~ åˆ™è¿”å›ç¬¬ä¸€ä¸ª ~resolve~ çš„ç»“æœçŠ¶æ€, 
å¦‚æœæ‰€æœ‰çš„ ~promise~ å‡ ~reject~ , åˆ™æŠ›å‡ºå¼‚å¸¸è¡¨ç¤ºæ‰€æœ‰è¯·æ±‚å¤±è´¥.

ä¸ ~race~ ç›¸ä¼¼, ä½† ~any~ å¼ºè°ƒå¿…é¡»ç¬¬ä¸€ä¸ª ~resolve~, ~race~ åªæ˜¯ç¬¬ä¸€ä¸ªå®Œæˆä¹Ÿå¯ä»¥æ˜¯ ~reject~ .

å½“æ‰€æœ‰ ~promise~ éƒ½æ˜¯ ~reject~ æ—¶, ä¼šè¿”å›ä¸€ä¸ª ~AggregateError~

** WeakRefs

ä½¿ç”¨ ~WeakRef~ çš„ ~Class~ ç±»å¯ä»¥åˆ›å»ºå¯¹å¯¹è±¡çš„å¼±å¼•ç”¨.
ç±»ä¼¼çš„è¿˜æœ‰ ~WeakMap~, ~WeakSet~ .

å› ä¸ºæ˜¯å¼±å¼•ç”¨ï¼Œæ‰€ä»¥ ~WeakMap~ ã€ ~WeakSet~ çš„é”®å€¼å¯¹æ˜¯ä¸å¯æšä¸¾çš„ ~WeakSet~ å’Œ ~WeakMap~ ç›¸ä¼¼ï¼Œ
ä½†æ˜¯æ¯ä¸ªå¯¹è±¡åœ¨ ~WeakSet~ ä¸­çš„æ¯ä¸ªå¯¹è±¡åªå¯èƒ½å‡ºç°ä¸€æ¬¡ï¼Œ ~WeakSet~ ä¸­æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯å”¯ä¸€çš„.
    
~WeakRef~ å®ä¾‹æœ‰ä¸€ä¸ªæ–¹æ³• ~deref~ ï¼Œè¿”å›å¼•ç”¨çš„åŸå§‹å¯¹è±¡ï¼Œå¦‚æœåŸå§‹å¯¹è±¡è¢«å›æ”¶ï¼Œåˆ™è¿”å› ~undefined~
    
~WeakSet~ ä¸ ~Set~ ç›¸æ¯”æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŒºåˆ«ï¼š
- ~WeakSet~ åªèƒ½æ˜¯å¯¹è±¡é›†åˆï¼Œè€Œä¸èƒ½æ˜¯ä»»ä½•ç±»å‹çš„ä»»æ„å€¼
- ~WeakSet~ å¼±å¼•ç”¨ï¼Œé›†åˆä¸­å¯¹è±¡å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–å¯¹ ~WeakSet~ å¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™ä¼šè¢« GC å›æ”¶

  #+begin_src js
    class MyCache {

      constructor() {
        this.cache = {}
      }

      add(key, obj) {
        this.cache[key] = new WeakRef(obj)
      }

      get(key) {
        let cachedRef = this.cache[key].deref()
        if(cachedRef) return cachedRef;
        return false;
      }
    }
  #+end_src

  å¥½å¤„å¯ä»¥å‡å°‘å¤æ‚é€’å½’ï¼Œå¾ªç¯é€ æˆçš„å†…å­˜æº¢å‡ºï¼Œå­˜å‚¨åˆ°ä¸å¿…è¦çš„å¯¹è±¡å’Œæ•°æ®.
  ç¼ºç‚¹æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½è¦æŸ¥è¯¢ä¸€éæ˜¯å¦å¯ç”¨.ï¼ˆå¿ƒæ™ºè´Ÿæ‹…å¤§äºä»·å€¼ï¼Ÿï¼‰
** æ–°çš„é€»è¾‘åˆ¤æ–­ç¬¦
- a ||= bï¼šå½“ a å€¼ä¸å­˜åœ¨æ—¶ï¼Œå°† b å˜é‡èµ‹å€¼ç»™ a
- a &&= bï¼šå½“ a å€¼å­˜åœ¨æ—¶ï¼Œå°† b å˜é‡èµ‹å€¼ç»™ a
- a ??= bï¼šå½“ a å€¼ä¸º null æˆ–è€… undefined æ—¶ï¼Œå°† b å˜é‡èµ‹å€¼ç»™ a

** Numeric Separators
æé«˜å¯è¯»æ€§

#+begin_src js
  let number = 100_000 // 100000
#+end_src

** List Format

#+begin_src js
  const arr = ['Pen', 'Pencil', 'Paper']
  let obj = new Intl.ListFormat('zh', { style: 'short', type: 'conjunction' })
  console.log(obj.format(arr)) // "Penã€Pencilå’ŒPaper"
#+end_src

** Date Format

#+begin_src js
  // Time only with short format
  let o = new Intl.DateTimeFormat('en' , { timeStyle: 'short' })
  console.log(o.format(Date.now()))
  // 11:27 PM


  // Time only with medium format
  o = new Intl.DateTimeFormat('en' , { timeStyle: 'medium'})
  console.log(o.format(Date.now()))
  // 11:27:57 PM


  // Time only with long format
  o = new Intl.DateTimeFormat('en' , { timeStyle: 'long' })
  console.log(o.format(Date.now()))
  // 11:27:57 PM GMT+11


  // Date only with short format
  o = new Intl.DateTimeFormat('en' , { dateStyle: 'short'})
  console.log(o.format(Date.now()))
  // 10/6/20


  // Date only with medium format
  o = new Intl.DateTimeFormat('en' , { dateStyle: 'medium'})
  console.log(o.format(Date.now()))
  // Oct 6, 2020


  // Date only with long format
  o = new Intl.DateTimeFormat('en' , { dateStyle: 'long'})
  console.log(o.format(Date.now()))
  // October 6, 2020
#+end_src

* 2020 Features

** nullish coalescing assignment
#+begin_src js
  x ??= y;
  // =
  x ?? (x = y);
#+end_src
